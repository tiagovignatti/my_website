{{ define "main" }}
{{ $meses := dict "January" "Jan" "February" "Fev" "March" "Mar" "April" "Abr" "May" "Mai" "June" "Jun" "July" "Jul" "August" "Ago" "September" "Set" "October" "Out" "November" "Nov" "December" "Dez" }}
<article class="servurb-page">
  <header class="servurb-header">
    <span class="servurb-label">Penha SC</span>
    <h1 class="servurb-title">Registro de Limpeza Urbana</h1>
    <p class="servurb-subtitle">Ocorrências de limpeza urbana da SERVURB em Penha, SC.</p>
  </header>

  <div class="servurb-table-container">
    <table class="servurb-table">
      <thead>
        <tr>
          <th>Local</th>
          <th>Última Limpeza</th>
          <th>Registros</th>
        </tr>
      </thead>
      <tbody>
        {{ range site.Data.penha }}
        <tr>
          <td class="servurb-local">{{ .local }}</td>
          <td class="servurb-data">
            {{ if .limpezas }}
              {{ $ultima := index .limpezas 0 }}
              <span class="servurb-dias" data-date="{{ $ultima.data }}"></span>
            {{ else }}
              <span class="servurb-sem-registro">Sem registro</span>
            {{ end }}
          </td>
          <td class="servurb-registros">
            {{ if .limpezas }}
              {{ $limpezas := .limpezas }}
              <div class="timeline">
                {{ range $i, $limpeza := $limpezas }}
                <div class="timeline-item"
                     data-date="{{ $limpeza.data }}"
                     {{ if gt $i 0 }}data-prev-date="{{ (index $limpezas (sub $i 1)).data }}"{{ end }}>

                  <!-- Gap indicator (except for first item) -->
                  {{ if gt $i 0 }}
                  <div class="timeline-gap">
                    <span class="timeline-gap-line"></span>
                    <span class="timeline-gap-text"></span>
                    <span class="timeline-gap-line"></span>
                  </div>
                  {{ end }}

                  <!-- Timeline content -->
                  <div class="timeline-event">
                    <div class="timeline-content">
                      <div class="timeline-date">
                        {{ $date := time $limpeza.data }}
                        {{ $day := $date.Format "02" }}
                        {{ $month := index $meses ($date.Format "January") }}
                        {{ $year := $date.Format "2006" }}
                        {{ printf "%s %s %s" $day $month $year }}
                      </div>
                      <div class="timeline-photos" data-gallery>
                        {{ range $limpeza.fotos }}
                          <img src="{{ . }}" alt="Foto de limpeza" class="servurb-foto-thumb nozoom" data-lightbox>
                        {{ end }}
                      </div>
                    </div>
                  </div>
                </div>
                {{ end }}
              </div>
            {{ else }}
              <span class="servurb-sem-foto">—</span>
            {{ end }}
          </td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>

  <footer class="servurb-footer">
    <p>© {{ now.Format "2006" }} <a href="/about/">Tiago Vignatti</a></p>
  </footer>
</article>

<!-- Lightbox -->
<div id="lightbox" class="lightbox">
  <div class="lightbox-overlay"></div>
  <div class="lightbox-content">
    <button class="lightbox-close" aria-label="Fechar">&times;</button>
    <button class="lightbox-prev" aria-label="Anterior">&#10094;</button>
    <img class="lightbox-img" src="" alt="Foto ampliada">
    <button class="lightbox-next" aria-label="Próxima">&#10095;</button>
  </div>
</div>

<script>
(function() {
  // Dynamic "days ago" calculation
  document.querySelectorAll('.servurb-dias[data-date]').forEach(el => {
    const dateStr = el.dataset.date;
    const cleaningDate = new Date(dateStr + 'T00:00:00');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const diffTime = today - cleaningDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 0) {
      el.textContent = 'Hoje';
    } else if (diffDays === 1) {
      el.textContent = 'Há 1 dia';
    } else {
      el.textContent = 'Há ' + diffDays + ' dias';
    }
  });

  // Calculate gaps between consecutive cleaning dates
  document.querySelectorAll('.timeline-item[data-prev-date]').forEach(el => {
    const currentDate = new Date(el.dataset.date + 'T00:00:00');
    const prevDate = new Date(el.dataset.prevDate + 'T00:00:00');
    const diffTime = prevDate - currentDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    const gapText = el.querySelector('.timeline-gap-text');
    if (gapText && diffDays > 0) {
      gapText.textContent = diffDays + ' dias';
    }
  });

  const lightbox = document.getElementById('lightbox');
  const lightboxImg = lightbox.querySelector('.lightbox-img');
  const overlay = lightbox.querySelector('.lightbox-overlay');
  const closeBtn = lightbox.querySelector('.lightbox-close');
  const prevBtn = lightbox.querySelector('.lightbox-prev');
  const nextBtn = lightbox.querySelector('.lightbox-next');

  let currentGallery = [];
  let currentIndex = 0;

  // Open lightbox
  document.querySelectorAll('[data-lightbox]').forEach(img => {
    img.style.cursor = 'pointer';
    img.addEventListener('click', function() {
      const gallery = this.closest('[data-gallery]');
      currentGallery = Array.from(gallery.querySelectorAll('[data-lightbox]')).map(i => i.src);
      currentIndex = currentGallery.indexOf(this.src);
      showImage();
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
    });
  });

  function showImage() {
    lightboxImg.src = currentGallery[currentIndex];
    prevBtn.style.display = currentGallery.length > 1 ? 'block' : 'none';
    nextBtn.style.display = currentGallery.length > 1 ? 'block' : 'none';
  }

  function closeLightbox() {
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
  }

  function prevImage() {
    currentIndex = (currentIndex - 1 + currentGallery.length) % currentGallery.length;
    showImage();
  }

  function nextImage() {
    currentIndex = (currentIndex + 1) % currentGallery.length;
    showImage();
  }

  // Event listeners
  closeBtn.addEventListener('click', closeLightbox);
  overlay.addEventListener('click', closeLightbox);
  prevBtn.addEventListener('click', prevImage);
  nextBtn.addEventListener('click', nextImage);

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (!lightbox.classList.contains('active')) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft') prevImage();
    if (e.key === 'ArrowRight') nextImage();
  });

  // Swipe support for mobile
  let touchStartX = 0;
  let touchEndX = 0;

  lightbox.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
  }, { passive: true });

  lightbox.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    const diff = touchStartX - touchEndX;
    if (Math.abs(diff) > 50) {
      if (diff > 0) nextImage();
      else prevImage();
    }
  }, { passive: true });
})();
</script>
{{ end }}
